<odoo>
    <!-- MS CGA Report Template -->
    <template id="template_ms_cga_invoice_document">
        <t t-call="web.basic_layout">
            <style>
                .table_mimpo {
                    margin-bottom: 10px;
                    font-size: 12px;
                }
                .table_mimpo .td_normal {
                    padding-left: 0px;
                    padding-top: 2px;
                    padding-right: 2px;
                    padding-bottom: 2px;
                    font-size: 12px;
                }
                .table_mimpo .td_double_border {
                    border-top: 1px solid black;
                    border-bottom: 1px solid black;
                    padding: 5px;
                    text-align: center;
                    vertical-align: middle;
                    font-size: 12px;
                }
                .table_mimpo .td_border_top_blue {
                    border-top: 1px solid black;
                    color: #3c78d8;
                    padding-left: 0px;
                    padding-top: 2px;
                    padding-right: 2px;
                    padding-bottom: 2px;
                    font-size: 12px;
                }
                .table_mimpo .td_border_top {
                    border-top: 1px solid black;
                    padding-left: 0px;
                    padding-top: 2px;
                    padding-right: 2px;
                    padding-bottom: 2px;
                    font-size: 12px;
                }
                .table_mimpo .th_line_left {
                    border-bottom: 1px solid black;
                    text-align: left;
                    bold: 1px;
                    padding-left: 0px;
                    padding-top: 2px;
                    padding-right: 2px;
                    padding-bottom: 2px;
                    font-size: 12px;
                }
                .table_mimpo .th_line_right {
                    border-bottom: 1px solid black;
                    text-align: right;
                    bold: 1px;
                    padding-left: 0px;
                    padding-top: 2px;
                    padding-right: 2px;
                    padding-bottom: 2px;
                    font-size: 12px;
                }
            </style>
            <div class="header">
                <div class="row col-12" style="font-size: 9px;">
                    <div class="col-7 mb4" style="border-bottom: 2px solid black; padding-bottom: 3px">
                        <img t-if="doc.company_id.logo" t-att-src="image_data_uri(doc.company_id.logo)" style="max-height: 45px;" alt="Logo"/>
                    </div>
                    <div class="col-1 mb4"/>
                    <div class="col-4 mb4">
                        <p style="font-size: 20px; text-align: left; vertical-align: middle;">
                            <span t-field="doc.name"/> <span t-if="not doc.name or doc.name == '/'" t-field="doc.id"/>
                        </p>
                    </div>
                </div>
                <div class="row col-12">
                    <div class="col-7 mb4" style="font-size: 9px;">
                        <p t-if="doc.company_id.company_details" t-field="doc.company_id.company_details"/>
                        <p t-else="" t-field="doc.company_id.partner_id" t-options="{&quot;widget&quot;: &quot;contact&quot;, &quot;fields&quot;: [&quot;address&quot;, &quot;name&quot;], &quot;no_marker&quot;: true}"/>
                    </div>
                    <div class="col-1 mb4"/>
                    <div class="col-4 mb4" style="font-size: 9px;">
                        <p t-field="doc.partner_id" t-options="{&quot;widget&quot;: &quot;contact&quot;, &quot;fields&quot;: [&quot;address&quot;, &quot;name&quot;], &quot;no_marker&quot;: true}"/>
                        RFC: <span t-field="doc.partner_id.vat"/>
                    </div>
                </div>
            </div>
            <div class="page">
                <t t-set="cfdi_vals" t-value="doc._l10n_mx_edi_decode_cfdi()"/>
                <t t-set="is_cfdi_signed" t-value="bool(doc._get_l10n_mx_edi_signed_edi_document())"/>
                <t t-set="downpayment" t-value="doc.get_related_downpayment()"/>
                <table class="table_mimpo table-borderless" name="sir_information" width="100%" style="font-size: 9px; margin-bottom: 10px;">
                    <tr>
                        <td width="60%"><strong>Expedido en</strong><span t-field="doc.company_id.zip"/> el: <span t-esc="doc.create_date.strftime('%Y-%m-%dT%H:%M:%S')" /></td>
                        <td><span t-field="doc.partner_id" /></td>
                    </tr>
                    <tr>
                        <td>Certificado SAT: 00001000000503727538</td>
                        <td><span t-field="doc.partner_id" />USO DE CFDI: <span t-field="doc.l10n_mx_edi_usage"/></td>
                    </tr>
                    <tr>
                        <td>Certificado Emisor: 00001000000505885023</td>
                        <td>Forma de Pago: <span t-field="doc.l10n_mx_edi_payment_method_id"/></td>
                    </tr>
                    <tr>
                        <td>Folio Fiscal: <span t-field="doc.l10n_mx_edi_cfdi_uuid"/></td>
                        <td>CONDICIONES DE PAGO: <span t-field="doc.invoice_payment_term_id"/></td>
                    </tr>
                </table>

                <table class="table_mimpo table-borderless" name="sir_information" width="100%" style="font-size: 9px !important;">
                    <tbody>
                        <tr>
                            <td width="10%" class="td_normal" style="margin-top: 10px; font-size: 9px !important;"><b>REFERENCIA</b></td>
                            <td width="16%" class="td_normal" style="margin-top: 10px; font-size: 9px !important;">: <span t-field="doc.sir_id.number"/></td>
                            <td width="14%" class="td_normal" style="margin-top: 10px; font-size: 9px !important;"><b>BUQUE</b></td>
                            <td width="16%" class="td_normal" style="margin-top: 10px; font-size: 9px !important;">: <span t-field="doc.sir_id.ship"/></td>
                            <td width="22%" class="td_normal" style="margin-top: 10px; font-size: 9px !important;"><b>FACTURAS</b></td>
                            <td width="22%" class="td_normal" style="margin-top: 10px; font-size: 9px !important;">: <span t-field="doc.sir_id.pedimento_invoice"/></td>
                        </tr>
                        <tr>
                            <td class="td_normal" style="font-size: 9px !important;">PEDIMENTO</td>
                            <td class="td_normal" style="font-size: 9px !important;">: <span t-field="doc.sir_id.pedimento"/></td>
                            <td class="td_normal" style="font-size: 9px !important;">PROVEEDOR</td>
                            <td class="td_normal" rowspan="2" style="font-size: 9px !important;">: <span t-field="doc.sir_id.supplier"/></td>
                            <td class="td_normal" style="font-size: 9px !important;">MARCAS Y NUMEROS</td>
                            <td class="td_normal" style="font-size: 9px !important;">: <span t-field="doc.sir_id.number_mark"/></td>
                        </tr>
                        <tr>
                            <td class="td_normal" style="font-size: 9px !important;">FECHA PED</td>
                            <td class="td_normal" style="font-size: 9px !important;">: <span t-field="doc.sir_id.pedimento_date"/></td>
                            <td class="td_normal" style="font-size: 9px !important;"></td>
                            <td class="td_normal" style="font-size: 9px !important;">MERCANCIA</td>
                            <td class="td_normal" style="font-size: 9px !important;">: <span t-field="doc.sir_id.ware"/></td>
                        </tr>
                        <tr>
                            <td class="td_normal" style="font-size: 9px !important;">REGIMEN</td>
                            <td class="td_normal" style="font-size: 9px !important;">: <span t-field="doc.sir_id.operation_type"/></td>
                            <td class="td_normal" style="font-size: 9px !important;">PESO EN KGS</td>
                            <td class="td_normal" style="font-size: 9px !important;">: <span t-field="doc.sir_id.total_weight"/></td>
                            <td class="td_normal" style="font-size: 9px !important;">CANTIDAD DE BULTOS</td>
                            <td class="td_normal" style="font-size: 9px !important;">: <span t-field="doc.sir_id.total_package"/></td>
                        </tr>
                        <tr>
                            <td class="td_normal" style="font-size: 9px !important;">ADUANA</td>
                            <td class="td_normal" style="font-size: 9px !important;">: <span t-field="doc.sir_id.custom_house"/></td>
                            <td class="td_normal" style="font-size: 9px !important;"></td>
                            <td class="td_normal" rowspan="2" style="font-size: 9px !important;"></td>
                            <td class="td_normal" style="font-size: 9px !important;">RECEPCION</td>
                            <td class="td_normal" style="font-size: 9px !important;">: <span t-field="doc.sir_id.reception"/></td>
                        </tr>
                        <tr>
                            <td class="td_normal"></td>
                            <td class="td_normal"></td>
                            <td class="td_normal"></td>
                            <td class="td_normal" style="font-size: 9px !important;">N* PEDIDO</td>
                            <td class="td_normal" style="font-size: 9px !important;">: <span t-field="doc.sir_id.order_number"/></td>
                        </tr>
                        <tr t-if="downpayment">
                            <td class="td_normal"></td>
                            <td class="td_normal"></td>
                            <td class="td_normal"></td>
                            <td class="td_normal" style="font-size: 9px !important;" colspan="2">
                                OBSERVACIONES: ANTICIPO DEL <span t-esc="downpayment.get('invoice_date')" />: <span t-esc="'{:,.2f}'.format(downpayment.get('amount', 0.0))" />
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <div width="100%" style="border-top: double; border-bottom: double; text-align: center; margin-bottom: 15px; font-size: 12px;">
                    <span>GASTOS EFECTUADOS POR CUENTA DEL CLIENTE</span>
                </div>
                <table name="cga_lines" width="90%" class="table-borderless" style="margin-left: 40px; font-size: 12px;">
                    <t t-foreach="doc.partner_expense_line_ids.filtered(lambda r: not r.to_agency)" t-as="line">
                        <tr>
                            <td style="height: 20px; vertical-align: middle;"><span t-field="line.name"/></td>
                            <td style="text-align: right; height: 20px; vertical-align: middle;"><span t-field="line.total_expense"/></td>
                        </tr>
                    </t>
                    <tr>
                        <td style="text-align: right">SUMA</td>
                        <td style="text-align: right"><span t-field="doc.total_expense"/></td>
                    </tr>
                </table>

                <table class="table_mimpo table-borderless" name="sir_information" width="100%">
                    <tbody>
                        <tr>
                            <td colspan="4" class="td_double_border" style="margin-bottom: 15px;"><b>HONORARIOS</b></td>
                        </tr>
                        <tr>
                            <td width="20%" class="td_normal" rowspan="6" style="padding-top: 5px; padding-left: 10px;">
                                <t t-if="is_cfdi_signed">
                                    <div t-if="cfdi_vals.get('sello')" class="barcode col-3">
                                        <img alt="Barcode" t-att-src="'/report/barcode/?barcode_type=QR&amp;value=%s&amp;width=100&amp;height=100' % quote_plus(
                                            'https://verificacfdi.facturaelectronica.sat.gob.mx/default.aspx?' + keep_query(
                                                re=doc.l10n_mx_edi_cfdi_supplier_rfc, rr=doc.l10n_mx_edi_cfdi_customer_rfc,
                                                tt='%.*f' % (doc.currency_id.decimal_places, doc.l10n_mx_edi_cfdi_amount), id=doc.l10n_mx_edi_cfdi_uuid)
                                                + '&amp;fe=%s' % quote_plus(
                                                    cfdi_vals['sello'][-8:], 'utf-8', 'strict', '=/').replace('%2B', '+'))"/>
                                    </div>
                                </t>
                            </td>
                            <td width="32%" class="td_normal">VALOR FACTURAS EN MONEDA</td>
                            <td width="32%" class="td_normal"><span t-field="doc.sir_id.total_custom_house"/></td>
                            <td width="16%" class="td_normal" rowspan="6"></td>
                        </tr>
                        <tr>
                            <td class="td_normal">IMPUESTOS</td>
                            <td class="td_normal"><span t-field="doc.sir_id.paid_tax"/></td>
                        </tr>
                        <tr>
                            <td class="td_normal">OTRAS CONTRIBUCIONES</td>
                            <td class="td_normal"></td>
                        </tr>
                        <tr>
                            <td class="td_normal">EROGACIONES</td>
                            <td class="td_normal"><span t-esc="'{:,.2f}'.format(doc.compute_non_agency_expense())"/></td>
                        </tr>
                        <tr>
                            <td class="td_normal">SUMA</td>
                            <td class="td_normal" style="border-top: 1px solid black;"><span t-esc="doc.total_expense"/></td>
                        </tr>
                        <tr>
                            <td class="td_normal"></td>
                            <td class="td_normal"></td>
                        </tr>
                        <tr>
                            <td class="td_normal"></td>
                            <td class="td_normal">HONORARIOS</td>
                            <td class="td_normal"></td>
                            <td class="td_normal"></td>
                        </tr>
                    </tbody>
                </table>

                <table name="sir_information" class="table_mimpo table-borderless" width="100%" style="margin-top: 5px;">
                    <thead>
                        <tr>
                            <th width="42%" class="th_line_left"><b>Description</b></th>
                            <th width="16%" class="th_line_right" style="padding-right:2px;"><b>Cantidad</b></th>
                            <th width="16%" class="th_line_right"><b>Precio unitario</b></th>
                            <th width="13%" class="th_line_left" style="padding-left:15px;"><b>Impuestos</b></th>
                            <th width="13%" class="th_line_right"><b>Importe</b></th>
                        </tr>
                    </thead>

                    <tbody class="invoice_tbody">
                        <t t-set="current_subtotal" t-value="0"/>
                        <t t-set="lines" t-value="doc.with_context(ms_cga=True).get_ms_invoice_lines()"/>
                        <t t-foreach="lines" t-as="line">
                            <t t-set="current_subtotal" t-value="current_subtotal + line.get('price_subtotal', 0.0)" groups="account.group_show_line_subtotals_tax_excluded"/>
                            <t t-set="current_subtotal" t-value="current_subtotal + line.get('price_total', 0.0)" groups="account.group_show_line_subtotals_tax_included"/>

                            <tr t-att-class="'bg-200 fw-bold o_line_section' if line.get('display_type') == 'line_section' else 'fst-italic o_line_note' if line.get('display_type') == 'line_note' else ''">
                                <t t-if="line.get('display_type') == 'product'" name="account_invoice_line_accountable">
                                    <td name="account_invoice_line_name" class="td_normal"><span t-esc="line.get('name')" t-options="{'widget': 'text'}"/></td>
                                    <td class="text-end td_normal">
                                        <span t-esc="line.get('quantity')"/>
                                        <span t-esc="line.get('product_uom_id').name"  groups="uom.group_uom"/>
                                    </td>
                                    <td clas="td_normal" style="padding-right:2px;" t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                                        <span class="text-nowrap" t-esc="'{:,.2f}'.format(line.get('price_unit'))"/>
                                    </td>
                                    <td class="td_normal" style="padding-left:15px;" t-attf-class="text-start {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                                        <span t-esc="', '.join(map(lambda x: (x.description or x.name), line.get('tax_ids')))" id="line_tax_ids"/>
                                    </td>
                                    <td class="text-end o_price_total td_normal">
                                        <span class="text-nowrap" t-esc="line.get('price_subtotal')" t-options='{"widget": "monetary", "display_currency": doc.currency_id}' groups="account.group_show_line_subtotals_tax_excluded"/>
                                        <span class="text-nowrap" t-esc="line.get('price_total')" t-options='{"widget": "monetary", "display_currency": doc.currency_id}' groups="account.group_show_line_subtotals_tax_included"/>
                                    </td>
                                </t>
                                <t t-if="line.get('display_type') == 'line_section'">
                                    <td colspan="99" class="td_normal">
                                        <span t-esc="line.get('name')" t-options="{'widget': 'text'}"/>
                                    </td>
                                    <!-- <t t-set="current_section" t-value="line"/>
                                    <t t-set="current_subtotal" t-value="0"/> -->
                                </t>
                                <t t-if="line.get('display_type') == 'line_note'">
                                    <td colspan="99" class="td_normal">
                                        <span t-esc="line.get('name')" t-options="{'widget': 'text'}"/>
                                    </td>
                                </t>
                            </tr>
                        </t>
                        <t t-set="tax_totals" t-value="doc.tax_totals"/> 
                        <tr>
                            <td/>
                            <td class="td_border_top_blue" colspan="3"><b>Importe sin impuestos</b></td>
                            <td class="td_border_top" style="text-align: right;"><span t-esc="current_subtotal" t-options='{"widget": "monetary", "display_currency": doc.currency_id}'/></td>
                        </tr>
                        <tr>
                            <td></td>
                            <td class="td_normal" colspan="3"></td>
                            <td></td>
                        </tr>
                        <t t-foreach="tax_totals['subtotals']" t-as="subtotal">
                            <t t-set="subtotal_to_show" t-value="subtotal['name']"/>
                            <t t-foreach="tax_totals['groups_by_subtotal'][subtotal_to_show]" t-as="amount_by_group">
                                <td></td>
                                <td class="td_normal" colspan="3">
                                    <span t-esc="amount_by_group['tax_group_name']"/>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;BASE <span t-esc="'{:,.2f}'.format(amount_by_group['tax_group_base_amount'])"/>
                                </td>
                                <td class="td_normal" style="text-align:right;">
                                    <span>
                                        <t t-esc="amount_by_group['formatted_tax_group_amount']"/>
                                    </span>
                                </td>
                            </t>
                        </t>
                        <tr>
                            <td></td>
                            <td class="td_normal" colspan="3">ANTICIPO</td>
                            <td style="text-align:right;">
                                <span t-if="doc.trusted_fund_statement_line_ids" t-esc="'{:,.2f}'.format(doc.trusted_fund_balance)"/>
                                <span t-if="not doc.trusted_fund_statement_line_ids and downpayment" t-esc="'{:,.2f}'.format(downpayment.get('amount', 0.0))" />
                            </td>
                        </tr>
                        <tr>
                            <td></td>
                            <td class="td_border_top_blue" colspan="3"><b>SALDO</b></td>
                            <td class="td_border_top" style="text-align: right;"><span t-esc="tax_totals['formatted_amount_total']"/></td>
                        </tr>
                    </tbody>
                </table>

                <div class="row">
                    <div class="col-2"/>
                    <div class="col-10" style="font-size: 12px;">
                        <div style="border-bottom: 1px solid black; margin-bottom: 3px;"><strong>SALDO: (<span t-esc="doc._l10n_mx_edi_cfdi_amount_to_text()"/>)</strong></div>
                        <div style="border-top: 1px solid black; margin-top: 2px;">Ingressos + IVA: (<span t-esc="doc._l10n_mx_edi_cfdi_amount_to_text()"/>)</div>
                    </div>
                </div>

                <table class="table_mimpo table-borderless" name="cfdi_relation" width="100%" style="margin-top: 5px; font-size: 10px !important;">
                    <t t-set="cfdi_origin" t-value="doc.get_cfdi_origin()" />
                    <tr style="border-top: 1px solid black; font-size: 11px !important; margin-bottom: 5px;">
                        <td colspan="2" class="text-center"><strong>CFDI RELACIONADO</strong></td>
                    </tr>
                    <tr style="border-top: 1px solid black;">
                        <td width="50%"><strong>Typo Relacion:</strong> <span t-if="cfdi_origin" t-esc="cfdi_origin[0]" /></td>
                        <td width="50%"><strong>UUID Relacionado:</strong> <span t-if="cfdi_origin" t-esc="cfdi_origin[1]" /></td>
                    </tr>
                </table>

                <t t-if="is_cfdi_signed">
                    <div class="complement-details col-12" style="page-break-inside: avoid; margin-top: 5px; border: 1px solid black; font-size: 9px; padding-left: 5px; padding-right: 5px;">
                        Fecha y Hora de Certificación: <span t-esc="cfdi_vals.get('emission_date_str')"/><br/>
                        <strong>Cadena original del complemento de certificación digital del SAT</strong><br/>
                        <div class="digital-stamp-content">
                            <span class="nowrap" t-esc="cfdi_vals.get('cadena')"/>
                        </div>
                        <strong>Sello del SAT</strong><br/>
                        <div class="digital-stamp-content">
                            <span t-esc="cfdi_vals.get('sello_sat')"/>
                        </div>
                        <strong>Sello digital del CFDI</strong><br/>
                        <div class="digital-stamp-content">
                            <span t-esc="cfdi_vals.get('sello')"/>
                        </div>
                    </div>
                </t>
                <div class="row" style="font-size: 11px; margin-top: 10px; page-break-inside: avoid;">
                    <div class="col-3">CLAVE CONFIRMACION:</div>
                    <div class="col-9" style="text-align: right">
                        <t t-if="doc.l10n_mx_edi_payment_policy">
                            METODO DO PAGO: <span t-field="doc.l10n_mx_edi_payment_policy" /> - 
                            <span t-if="doc.l10n_mx_edi_payment_policy == 'PPD'">PAGO EN PARCIALIDADES O DIFERIDO</span>
                            <span t-if="doc.l10n_mx_edi_payment_policy == 'PUE'">PAGO EN UNA SOLA EXHIBICION</span>
                        </t>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <template id="template_ms_cga_report">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-set="lang" t-value="doc.partner_id.lang"/>
                <t t-call="mpo_cga_report.template_ms_cga_invoice_document" t-lang="lang"/>
            </t>
        </t>
    </template>

    <record id="report_ms_cga_invoice" model="ir.actions.report">
        <field name="name">Factura MS + CGA</field>
        <field name="model">account.move</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">mpo_cga_report.template_ms_cga_report</field>
        <field name="report_file">mpo_cga_report.template_ms_cga_report</field>
        <field name="print_report_name">(object._get_report_base_filename())</field>
        <!-- <field name="binding_model_id" ref="account.model_account_move"/> -->
        <field name="paperformat_id" ref="mpo_cga_report.paperformat_cga_report"/>
        <field name="binding_type">report</field>
    </record>

    <template id="mimpo_account_move_template_extend" inherit_id="mpo_invoice_report.mimpo_account_move_template">
        <xpath expr="//table[@name='gastos_info']/tr[1]" position="after">
            <tr t-foreach="doc.partner_expense_line_ids.filtered(lambda r: not r.to_agency)" t-as="exp">
                <td class="td_normal" colspan="2"><span t-field="exp.expense_description"/></td>
                <td class="td_normal" style="text-align: right;"><span t-field="exp.total_expense"/></td>
            </tr>
        </xpath>
        <xpath expr="//table[@name='gastos_info']/tr/td[@name='gastos_suma']" position="inside">
            <span t-field="doc.total_expense"/>
        </xpath>
        <xpath expr="//table[@name='table_hono']" position="attributes">
            <attribute name="t-if">not doc.partner_expense_line_ids</attribute>
        </xpath>
        <xpath expr="//table[@name='table_hono']//td[@name='td_eroga']" position="inside">
            <t t-set="eroga_expense" t-value="doc.compute_non_agency_expense()"/>
            <span t-esc="'{:,.2f}'.format(eroga_expense)"/>
        </xpath>
        <xpath expr="//table[@name='table_hono']//td[@name='table_suma_hono']" position="inside">
            <t t-set="suma_hono" t-value="doc.sir_id.total_custom_house + doc.sir_id.paid_tax + eroga_expense"/>
            <span t-esc="'{:,.2f}'.format(suma_hono)"/>
        </xpath>
    </template>
</odoo>